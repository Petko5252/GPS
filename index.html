<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Modern GPS</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-geometryutil@0.10.2/src/leaflet.geometryutil.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: { 'up': '0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -1px rgba(0, 0, 0, 0.06)' }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        /* Hide scrollbar for Chrome/Safari/Opera */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Pulse Animation for User Marker */
        .gps-pulse {
            width: 20px; height: 20px; background: #3B82F6; border-radius: 50%; border: 3px solid white;
            box-shadow: 0 0 0 rgba(59, 130, 246, 0.4);
            animation: pulse 2s infinite;
        }
        .gps-arrow { display: block; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 12px solid #3B82F6; margin: -28px auto 0 auto; transform-origin: bottom center; transition: transform 0.3s ease; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Glassmorphism Classes */
        .glass-panel { @apply bg-white/90 dark:bg-gray-800/90 backdrop-blur-md shadow-lg border border-white/20 dark:border-gray-700/30; }
        
        /* Map Controls Fix */
        .leaflet-control-zoom { display: none !important; } /* We will build custom controls */
        .leaflet-bottom.leaflet-right { margin-bottom: 80px; } /* Move attribution up */
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 overflow-hidden w-screen h-screen relative">

    <div id="map" class="absolute inset-0 z-0 bg-gray-200 dark:bg-gray-900"></div>

    <div class="absolute inset-0 z-10 pointer-events-none flex flex-col justify-between p-4">

        <div id="top-bar" class="w-full max-w-md mx-auto pointer-events-auto transition-all duration-300">
            <div id="search-box" class="glass-panel rounded-full flex items-center p-1 transition-all">
                <div class="pl-3 pr-2 text-gray-400"><i class="ph-bold ph-magnifying-glass text-xl"></i></div>
                <input type="text" id="search-input" placeholder="Where to?" class="flex-grow bg-transparent focus:outline-none text-gray-800 dark:text-gray-100 placeholder-gray-500 py-3 text-base" />
                <div id="loader" class="hidden w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mr-3"></div>
                <button id="settings-btn" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 flex items-center justify-center mr-1">
                    <i class="ph-fill ph-list text-xl"></i>
                </button>
            </div>
            
            <div id="search-results" class="hidden mt-2 glass-panel rounded-2xl overflow-hidden max-h-60 overflow-y-auto no-scrollbar mx-2"></div>

            <div id="nav-instruction-card" class="hidden glass-panel rounded-2xl p-4 mt-2 bg-blue-600 dark:bg-blue-700 text-white border-none shadow-xl">
                <div class="flex items-start gap-4">
                    <div id="maneuver-icon-container" class="text-4xl opacity-90 mt-1"></div>
                    <div class="flex-grow">
                        <h2 id="maneuver-distance" class="text-3xl font-bold tracking-tight">0 m</h2>
                        <p id="maneuver-text" class="text-lg font-medium opacity-90 leading-tight mt-1">Starting navigation...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex flex-col gap-3 pointer-events-auto">
            <button id="theme-toggle" class="glass-panel w-12 h-12 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-200 hover:scale-105 transition-transform">
                <i class="ph-fill ph-moon dark:hidden text-xl"></i>
                <i class="ph-fill ph-sun hidden dark:inline text-xl"></i>
            </button>
            <button id="recenter-btn" class="glass-panel w-12 h-12 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 hover:scale-105 transition-transform">
                <i class="ph-bold ph-navigation-arrow text-xl transform -rotate-45"></i>
            </button>
            <button id="mute-btn" class="glass-panel w-12 h-12 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-200 hover:scale-105 transition-transform">
                <i id="mute-icon" class="ph-bold ph-speaker-high text-xl"></i>
            </button>
        </div>

        <div id="bottom-sheet" class="w-full max-w-md mx-auto pointer-events-auto transition-transform duration-300 translate-y-0">
            
            <div id="mode-selector" class="glass-panel rounded-full p-1 mb-4 flex justify-between gap-1 w-max mx-auto shadow-md">
                <button data-mode="driving" class="mode-btn active px-6 py-2 rounded-full text-sm font-semibold flex items-center gap-2 bg-blue-600 text-white shadow-sm transition-all">
                    <i class="ph-fill ph-car"></i> Drive
                </button>
                <button data-mode="cycling" class="mode-btn px-6 py-2 rounded-full text-sm font-semibold flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="ph-fill ph-bicycle"></i> Bike
                </button>
                <button data-mode="walking" class="mode-btn px-6 py-2 rounded-full text-sm font-semibold flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="ph-fill ph-person"></i> Walk
                </button>
            </div>

            <div id="route-preview" class="hidden glass-panel rounded-3xl p-5 shadow-up pb-8">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-medium uppercase tracking-wide">Destination</p>
                        <h2 id="dest-name" class="text-xl font-bold text-gray-800 dark:text-white truncate max-w-[200px]">Selected Location</h2>
                    </div>
                    <div class="text-right">
                        <p id="preview-duration" class="text-2xl font-bold text-green-600 dark:text-green-400">-- min</p>
                        <p id="preview-distance" class="text-sm text-gray-500 dark:text-gray-400">-- km</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="cancel-route-btn" class="flex-1 py-4 rounded-2xl bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-bold hover:brightness-95 transition-all">Cancel</button>
                    <button id="start-nav-btn" class="flex-[2] py-4 rounded-2xl bg-blue-600 text-white font-bold text-lg shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                        <i class="ph-bold ph-navigation-arrow"></i> Start
                    </button>
                </div>
            </div>

            <div id="nav-status" class="hidden glass-panel rounded-t-3xl p-5 shadow-up pb-8 -mb-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-3xl font-bold text-gray-800 dark:text-white" id="nav-eta">--:--</p>
                        <p class="text-green-600 dark:text-green-400 font-medium"><span id="nav-min">0</span> min â€¢ <span id="nav-km">0</span> km</p>
                    </div>
                    <button id="end-nav-btn" class="w-14 h-14 rounded-full bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400 flex items-center justify-center hover:bg-red-200 transition-colors">
                        <i class="ph-bold ph-x text-2xl"></i>
                    </button>
                </div>
                <div class="w-full h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div id="trip-progress" class="h-full bg-green-500 w-0 transition-all duration-1000"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- State Management ---
        const state = {
            map: null, userMarker: null, destMarker: null, routeLayer: null,
            watchId: null, currentLocation: null, isNavigating: false,
            travelMode: 'driving', routeData: null, voices: [], 
            isMuted: false, etaInterval: null, searchTimeout: null
        };

        const dom = {
            map: document.getElementById('map'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            loader: document.getElementById('loader'),
            routePreview: document.getElementById('route-preview'),
            navStatus: document.getElementById('nav-status'),
            navInstruction: document.getElementById('nav-instruction-card'),
            modeSelector: document.getElementById('mode-selector'),
            searchBox: document.getElementById('search-box'),
            muteIcon: document.getElementById('mute-icon'),
            themeToggle: document.getElementById('theme-toggle'),
            // Text Elements
            previewDuration: document.getElementById('preview-duration'),
            previewDistance: document.getElementById('preview-distance'),
            destName: document.getElementById('dest-name'),
            navEta: document.getElementById('nav-eta'),
            navMin: document.getElementById('nav-min'),
            navKm: document.getElementById('nav-km'),
            maneuverDist: document.getElementById('maneuver-distance'),
            maneuverText: document.getElementById('maneuver-text'),
            maneuverIcon: document.getElementById('maneuver-icon-container'),
            tripProgress: document.getElementById('trip-progress')
        };

        // --- Initialization ---
        function init() {
            // Load Voices
            if ('speechSynthesis' in window) {
                state.voices = speechSynthesis.getVoices();
                speechSynthesis.onvoiceschanged = () => { state.voices = speechSynthesis.getVoices(); };
            }

            // Init Map
            state.map = L.map(dom.map, { zoomControl: false, attributionControl: true }).setView([0, 0], 13);
            
            // Tile Layers
            const lightTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 20 });
            const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 });

            // Theme Check
            const updateTheme = () => {
                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) { darkTiles.addTo(state.map); lightTiles.remove(); }
                else { lightTiles.addTo(state.map); darkTiles.remove(); }
            };
            
            // Initial Theme
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            updateTheme();

            // Event Listeners
            dom.themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                updateTheme();
            });

            document.getElementById('recenter-btn').addEventListener('click', () => {
                if(state.currentLocation) state.map.flyTo(state.currentLocation, 17, {animate: true, duration: 1});
            });

            dom.searchInput.addEventListener('input', (e) => {
                clearTimeout(state.searchTimeout);
                if(e.target.value.length > 2) {
                    dom.loader.classList.remove('hidden');
                    state.searchTimeout = setTimeout(() => performSearch(e.target.value), 500);
                } else {
                    dom.searchResults.classList.add('hidden');
                }
            });

            // Mode Switching
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if(state.isNavigating) return;
                    document.querySelectorAll('.mode-btn').forEach(b => {
                        b.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-sm');
                        b.classList.add('text-gray-600', 'dark:text-gray-300');
                    });
                    const target = e.currentTarget;
                    target.classList.add('active', 'bg-blue-600', 'text-white', 'shadow-sm');
                    target.classList.remove('text-gray-600', 'dark:text-gray-300');
                    state.travelMode = target.dataset.mode;
                    if(state.destMarker && state.currentLocation) calculateRoute(state.currentLocation, state.destMarker.getLatLng());
                });
            });

            document.getElementById('start-nav-btn').addEventListener('click', startNavigation);
            document.getElementById('end-nav-btn').addEventListener('click', endNavigation);
            document.getElementById('cancel-route-btn').addEventListener('click', clearRoute);
            
            document.getElementById('mute-btn').addEventListener('click', () => {
                state.isMuted = !state.isMuted;
                dom.muteIcon.className = state.isMuted ? 'ph-bold ph-speaker-slash text-xl' : 'ph-bold ph-speaker-high text-xl';
            });

            // Start GPS
            if("geolocation" in navigator) {
                state.watchId = navigator.geolocation.watchPosition(
                    updateUserLocation, 
                    (err) => console.error(err), 
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }
        }

        // --- Core Functions ---

        function updateUserLocation(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const newLatLng = L.latLng(lat, lng);
            state.currentLocation = newLatLng;

            // Create/Update Marker
            if (!state.userMarker) {
                const iconHtml = `<div class="gps-pulse"></div><div class="gps-arrow"></div>`;
                const customIcon = L.divIcon({ className: 'custom-gps-icon', html: iconHtml, iconSize: [20, 20], iconAnchor: [10, 10] });
                state.userMarker = L.marker(newLatLng, { icon: customIcon }).addTo(state.map);
                state.map.setView(newLatLng, 16);
            } else {
                state.userMarker.setLatLng(newLatLng);
                // Rotate arrow based on heading if available
                if (pos.coords.heading !== null) {
                    const arrow = document.querySelector('.gps-arrow');
                    if(arrow) arrow.style.transform = `rotate(${pos.coords.heading}deg)`;
                }
            }

            if (state.isNavigating) {
                // Keep map centered near bottom in nav mode
                state.map.panTo(newLatLng, { animate: true, easeLinearity: 0.5 });
                updateNavLogic(newLatLng);
            }
        }

        async function performSearch(query) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=4`);
                const data = await res.json();
                dom.loader.classList.add('hidden');
                dom.searchResults.innerHTML = '';
                
                if (data.length > 0) {
                    dom.searchResults.classList.remove('hidden');
                    data.forEach(place => {
                        const div = document.createElement('div');
                        div.className = "p-4 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer flex items-center gap-3 transition-colors";
                        div.innerHTML = `
                            <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-full text-gray-500"><i class="ph-bold ph-map-pin"></i></div>
                            <div>
                                <p class="font-semibold text-gray-800 dark:text-gray-200 text-sm">${place.display_name.split(',')[0]}</p>
                                <p class="text-xs text-gray-500 truncate w-60">${place.display_name}</p>
                            </div>
                        `;
                        div.onclick = () => selectDestination(place);
                        dom.searchResults.appendChild(div);
                    });
                } else {
                    dom.searchResults.classList.add('hidden');
                }
            } catch (e) {
                dom.loader.classList.add('hidden');
            }
        }

        function selectDestination(place) {
            const latLng = L.latLng(place.lat, place.lon);
            dom.searchResults.classList.add('hidden');
            dom.searchInput.value = place.display_name.split(',')[0];
            dom.destName.textContent = place.display_name.split(',')[0];
            
            if (state.destMarker) state.map.removeLayer(state.destMarker);
            state.destMarker = L.marker(latLng, { icon: L.divIcon({html: '<i class="ph-fill ph-map-pin text-4xl text-red-500 drop-shadow-md" style="margin-top:-36px; margin-left:-18px;"></i>', className: 'dest-icon'}) }).addTo(state.map);
            
            if (state.currentLocation) {
                calculateRoute(state.currentLocation, latLng);
            }
        }

        async function calculateRoute(start, end) {
            const profileMap = { 'driving': 'car', 'walking': 'foot', 'cycling': 'bike' };
            const profile = profileMap[state.travelMode];
            
            const url = `https://router.project-osrm.org/route/v1/${profile}/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson&steps=true`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if(data.routes && data.routes.length > 0) {
                    state.routeData = data.routes[0];
                    const route = data.routes[0];
                    
                    if (state.routeLayer) state.map.removeLayer(state.routeLayer);
                    
                    const latLngs = route.geometry.coordinates.map(c => [c[1], c[0]]);
                    state.routeLayer = L.polyline(latLngs, { color: '#3B82F6', weight: 6, opacity: 0.8 }).addTo(state.map);
                    state.map.fitBounds(state.routeLayer.getBounds(), { padding: [50, 50] });

                    // Update Preview UI
                    dom.previewDuration.textContent = Math.round(route.duration / 60) + " min";
                    dom.previewDistance.textContent = (route.distance / 1000).toFixed(1) + " km";
                    
                    dom.routePreview.classList.remove('hidden');
                    dom.modeSelector.classList.add('hidden');
                }
            } catch (e) { console.error("Route Error", e); }
        }

        function clearRoute() {
            if (state.routeLayer) state.map.removeLayer(state.routeLayer);
            if (state.destMarker) state.map.removeLayer(state.destMarker);
            dom.routePreview.classList.add('hidden');
            dom.modeSelector.classList.remove('hidden');
            dom.searchInput.value = '';
            state.map.setView(state.currentLocation, 16);
        }

        function startNavigation() {
            if(!state.routeData) return;
            state.isNavigating = true;
            
            // UI Transition
            dom.routePreview.classList.add('hidden');
            dom.searchBox.classList.add('opacity-0', 'pointer-events-none');
            dom.navStatus.classList.remove('hidden');
            dom.navInstruction.classList.remove('hidden');
            
            // Initial Data
            updateNavUI(state.routeData.distance, state.routeData.duration);
            const firstStep = state.routeData.legs[0].steps[0];
            updateInstruction(firstStep);
            
            state.map.setZoom(18);
            state.map.panTo(state.currentLocation);
        }

        function endNavigation() {
            state.isNavigating = false;
            dom.navStatus.classList.add('hidden');
            dom.navInstruction.classList.add('hidden');
            dom.searchBox.classList.remove('opacity-0', 'pointer-events-none');
            dom.routePreview.classList.remove('hidden');
            state.map.setZoom(15);
            state.map.fitBounds(state.routeLayer.getBounds(), { padding: [50, 50] });
        }

        function updateNavLogic(userLoc) {
            // Simplified logic: Find closest point on polyline to calculate remaining distance
            // In a real production app, you'd snap to the segment index
            if(!state.routeLayer) return;
            const closest = L.GeometryUtil.closest(state.map, state.routeLayer, userLoc);
            const distToDest = userLoc.distanceTo(state.destMarker.getLatLng()); // Crow flies approx for smoothness
            
            // Speed assumption (m/s) based on mode
            const speeds = { driving: 13, cycling: 5, walking: 1.4 };
            const speed = speeds[state.travelMode];
            const remainingSec = distToDest / speed;
            
            updateNavUI(distToDest, remainingSec);

            // Mock Step Logic (just for visual demo - simply shows the next turn based on proximity)
            const steps = state.routeData.legs[0].steps;
            // This is a naive implementation. Real nav needs "current step index" tracking.
            // For this UI demo, we leave the first step or random updates.
        }

        function updateNavUI(distMeters, durationSec) {
            const now = new Date();
            const arrival = new Date(now.getTime() + durationSec * 1000);
            
            dom.navEta.textContent = arrival.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            dom.navMin.textContent = Math.ceil(durationSec / 60);
            dom.navKm.textContent = (distMeters / 1000).toFixed(1);
            
            // Update Progress Bar
            const totalDist = state.routeData.distance;
            const percent = Math.min(100, Math.max(0, ((totalDist - distMeters) / totalDist) * 100));
            dom.tripProgress.style.width = `${percent}%`;
        }

        function updateInstruction(step) {
            const icons = {
                'turn': 'ph-arrow-bend-up-right',
                'new name': 'ph-arrow-up',
                'depart': 'ph-navigation-arrow',
                'arrive': 'ph-flag-checkered',
                'default': 'ph-arrow-up'
            };
            
            // Determine icon based on modifier/type
            let iconClass = icons.default;
            if(step.maneuver.modifier && step.maneuver.modifier.includes('left')) iconClass = 'ph-arrow-bend-up-left';
            if(step.maneuver.modifier && step.maneuver.modifier.includes('right')) iconClass = 'ph-arrow-bend-up-right';
            if(step.maneuver.type === 'arrive') iconClass = icons.arrive;

            dom.maneuverIcon.innerHTML = `<i class="ph-bold ${iconClass}"></i>`;
            dom.maneuverDist.textContent = step.distance < 1000 ? `${Math.round(step.distance)} m` : `${(step.distance/1000).toFixed(1)} km`;
            
            let instruction = step.maneuver.instruction || step.name || "Proceed";
            dom.maneuverText.textContent = instruction;

            if (!state.isMuted) speak(instruction);
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(u);
        }

        init();
    </script>
</body>
</html>
