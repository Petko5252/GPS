<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>GPS Navigation</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil@0.10.2/src/leaflet.geometryutil.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    // Custom utility for mobile safe areas (iPhone home bar)
                    spacing: { 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Pulse Animation for User Location */
        .gps-pulse {
            width: 22px; height: 22px; background: #3B82F6; border-radius: 50%; border: 3px solid white;
            box-shadow: 0 0 0 rgba(59, 130, 246, 0.4);
            animation: pulse 2s infinite;
        }
        .gps-arrow { 
            display: block; width: 0; height: 0; 
            border-left: 7px solid transparent; border-right: 7px solid transparent; border-bottom: 10px solid #3B82F6; 
            margin: -30px auto 0 auto; transform-origin: bottom center; transition: transform 0.3s ease; 
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Glassmorphism Styles */
        .glass-panel { 
            @apply bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl shadow-xl border border-white/20 dark:border-gray-700/30; 
        }
        
        /* Map Cleanups */
        .leaflet-control-zoom { display: none !important; }
        .leaflet-bottom { bottom: 100px !important; } /* Move logo out of way */
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 overflow-hidden w-screen h-screen relative">

    <div id="map" class="absolute inset-0 z-0 bg-gray-200 dark:bg-gray-900"></div>

    <div class="absolute inset-0 z-10 pointer-events-none flex flex-col justify-between">
        
        <div class="w-full p-4 pt-12 pointer-events-auto">
            <div id="search-box" class="glass-panel rounded-full flex items-center p-1 max-w-md mx-auto transition-all">
                <div class="p-3 text-gray-500"><i class="ph-bold ph-magnifying-glass text-xl"></i></div>
                <input type="text" id="search-input" placeholder="Search destination..." class="flex-grow bg-transparent focus:outline-none text-gray-800 dark:text-gray-100 placeholder-gray-500 py-2 text-base" />
                <div id="loader" class="hidden w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mr-3"></div>
            </div>
            
            <div id="search-results" class="hidden mt-2 glass-panel rounded-2xl overflow-hidden max-h-60 overflow-y-auto no-scrollbar max-w-md mx-auto"></div>

            <div id="nav-instruction-card" class="hidden glass-panel rounded-2xl p-4 mt-2 bg-blue-600 dark:bg-blue-700 text-white border-none shadow-2xl max-w-md mx-auto transform transition-all">
                <div class="flex items-start gap-4">
                    <div id="maneuver-icon-container" class="text-4xl opacity-90 mt-1"></div>
                    <div class="flex-grow">
                        <h2 id="maneuver-distance" class="text-4xl font-bold tracking-tight">0 m</h2>
                        <p id="maneuver-text" class="text-lg font-medium opacity-90 leading-tight mt-1">Ready to start</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex flex-col gap-3 pointer-events-auto">
            <button id="theme-toggle" class="glass-panel w-12 h-12 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-200 active:scale-90 transition-transform">
                <i class="ph-fill ph-moon dark:hidden text-xl"></i><i class="ph-fill ph-sun hidden dark:inline text-xl"></i>
            </button>
            <button id="recenter-btn" class="glass-panel w-12 h-12 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 active:scale-90 transition-transform">
                <i class="ph-bold ph-navigation-arrow text-xl transform -rotate-45"></i>
            </button>
            <button id="mute-btn" class="glass-panel w-12 h-12 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-200 active:scale-90 transition-transform">
                <i id="mute-icon" class="ph-bold ph-speaker-high text-xl"></i>
            </button>
        </div>

        <div id="bottom-sheet" class="w-full max-w-md mx-auto pointer-events-auto transition-transform duration-300 pb-safe pl-4 pr-4 mb-8">
            
            <div id="mode-selector" class="glass-panel rounded-2xl p-2 mb-4 flex justify-between gap-1 shadow-lg">
                <button data-mode="driving" class="mode-btn active flex-1 py-3 rounded-xl text-sm font-bold flex flex-col items-center gap-1 bg-blue-100 text-blue-700 dark:bg-blue-600 dark:text-white transition-all">
                    <i class="ph-fill ph-car text-xl"></i> <span>Drive</span>
                </button>
                <button data-mode="cycling" class="mode-btn flex-1 py-3 rounded-xl text-sm font-medium flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="ph-fill ph-bicycle text-xl"></i> <span>Bike</span>
                </button>
                <button data-mode="walking" class="mode-btn flex-1 py-3 rounded-xl text-sm font-medium flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="ph-fill ph-person text-xl"></i> <span>Walk</span>
                </button>
            </div>

            <div id="route-preview" class="hidden glass-panel rounded-3xl p-5 shadow-2xl">
                <div class="flex justify-between items-end mb-4">
                    <div class="overflow-hidden">
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider mb-1">Destination</p>
                        <h2 id="dest-name" class="text-xl font-bold text-gray-800 dark:text-white truncate">Selected Location</h2>
                    </div>
                    <div class="text-right whitespace-nowrap pl-4">
                        <p id="preview-duration" class="text-3xl font-extrabold text-blue-600 dark:text-blue-400">--</p>
                        <p id="preview-distance" class="text-sm font-medium text-gray-500 dark:text-gray-400">-- km</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="cancel-route-btn" class="flex-1 py-4 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-bold active:scale-95 transition-all">Cancel</button>
                    <button id="start-nav-btn" class="flex-[2] py-4 rounded-xl bg-blue-600 text-white font-bold text-lg shadow-lg shadow-blue-500/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i class="ph-bold ph-navigation-arrow"></i> GO
                    </button>
                </div>
            </div>

            <div id="nav-status" class="hidden glass-panel rounded-3xl p-5 shadow-2xl">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase">Arrival</p>
                        <p class="text-4xl font-extrabold text-gray-800 dark:text-white" id="nav-eta">--:--</p>
                        <p class="text-green-600 dark:text-green-400 font-bold mt-1 text-sm"><span id="nav-min">0</span> min â€¢ <span id="nav-km">0</span> km</p>
                    </div>
                    <button id="end-nav-btn" class="w-16 h-16 rounded-full bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400 flex items-center justify-center active:scale-90 transition-all shadow-md">
                        <i class="ph-bold ph-x text-3xl"></i>
                    </button>
                </div>
                <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div id="trip-progress" class="h-full bg-blue-500 w-0 transition-all duration-1000 ease-linear"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const state = {
            map: null, userMarker: null, destMarker: null, routeLayer: null,
            watchId: null, currentLocation: null, isNavigating: false,
            travelMode: 'driving', routeData: null, voices: [], 
            isMuted: false, searchTimeout: null
        };

        const dom = {
            map: document.getElementById('map'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            loader: document.getElementById('loader'),
            routePreview: document.getElementById('route-preview'),
            navStatus: document.getElementById('nav-status'),
            navInstruction: document.getElementById('nav-instruction-card'),
            modeSelector: document.getElementById('mode-selector'),
            searchBox: document.getElementById('search-box'),
            muteIcon: document.getElementById('mute-icon'),
            previewDuration: document.getElementById('preview-duration'),
            previewDistance: document.getElementById('preview-distance'),
            destName: document.getElementById('dest-name'),
            navEta: document.getElementById('nav-eta'),
            navMin: document.getElementById('nav-min'),
            navKm: document.getElementById('nav-km'),
            maneuverDist: document.getElementById('maneuver-distance'),
            maneuverText: document.getElementById('maneuver-text'),
            maneuverIcon: document.getElementById('maneuver-icon-container'),
            tripProgress: document.getElementById('trip-progress')
        };

        function init() {
            // Setup Map
            state.map = L.map(dom.map, { zoomControl: false, attributionControl: false }).setView([0, 0], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(state.map);

            // Theme Handling
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
            document.getElementById('theme-toggle').addEventListener('click', () => document.documentElement.classList.toggle('dark'));

            // UI Actions
            document.getElementById('recenter-btn').addEventListener('click', () => {
                if(state.currentLocation) state.map.flyTo(state.currentLocation, 18, {animate: true, duration: 1});
            });

            // Travel Mode Switcher
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if(state.isNavigating) return;
                    
                    // Reset all buttons
                    document.querySelectorAll('.mode-btn').forEach(b => {
                        b.className = 'mode-btn flex-1 py-3 rounded-xl text-sm font-medium flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all';
                    });
                    
                    // Highlight active button
                    const target = e.currentTarget;
                    target.className = 'mode-btn active flex-1 py-3 rounded-xl text-sm font-bold flex flex-col items-center gap-1 bg-blue-100 text-blue-700 dark:bg-blue-600 dark:text-white transition-all shadow-inner';
                    
                    state.travelMode = target.dataset.mode;
                    if(state.destMarker && state.currentLocation) calculateRoute(state.currentLocation, state.destMarker.getLatLng());
                });
            });

            // Search Logic
            dom.searchInput.addEventListener('input', (e) => {
                clearTimeout(state.searchTimeout);
                if(e.target.value.length > 2) {
                    dom.loader.classList.remove('hidden');
                    state.searchTimeout = setTimeout(() => performSearch(e.target.value), 500);
                } else dom.searchResults.classList.add('hidden');
            });

            // Navigation Buttons
            document.getElementById('start-nav-btn').addEventListener('click', startNavigation);
            document.getElementById('end-nav-btn').addEventListener('click', endNavigation);
            document.getElementById('cancel-route-btn').addEventListener('click', clearRoute);
            
            // Voice Setup
            if ('speechSynthesis' in window) {
                state.voices = speechSynthesis.getVoices();
                speechSynthesis.onvoiceschanged = () => { state.voices = speechSynthesis.getVoices(); };
            }

            // Start GPS Watch
            if("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updateUserLocation, console.error, { enableHighAccuracy: true, maximumAge: 0 });
            }
        }

        function updateUserLocation(pos) {
            const latLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
            state.currentLocation = latLng;

            if (!state.userMarker) {
                const iconHtml = `<div class="gps-pulse"></div><div class="gps-arrow"></div>`;
                state.userMarker = L.marker(latLng, { 
                    icon: L.divIcon({ className: 'custom-gps-icon', html: iconHtml, iconSize: [22, 22], iconAnchor: [11, 11] }) 
                }).addTo(state.map);
                state.map.setView(latLng, 16);
            } else {
                state.userMarker.setLatLng(latLng);
                if (pos.coords.heading !== null) {
                    const arrow = document.querySelector('.gps-arrow');
                    if(arrow) arrow.style.transform = `rotate(${pos.coords.heading}deg)`;
                }
            }

            if (state.isNavigating) {
                state.map.panTo(latLng, { animate: true, duration: 1 });
                updateNavLogic(latLng);
            }
        }

        async function performSearch(query) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=4`);
                const data = await res.json();
                dom.loader.classList.add('hidden');
                dom.searchResults.innerHTML = '';
                if (data.length > 0) {
                    dom.searchResults.classList.remove('hidden');
                    data.forEach(place => {
                        const div = document.createElement('div');
                        div.className = "p-4 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer flex items-center gap-3";
                        div.innerHTML = `<i class="ph-fill ph-map-pin text-gray-400 text-xl"></i><div><p class="font-bold text-gray-800 dark:text-gray-200 text-sm">${place.display_name.split(',')[0]}</p><p class="text-xs text-gray-500 truncate w-64">${place.display_name}</p></div>`;
                        div.onclick = () => selectDestination(place);
                        dom.searchResults.appendChild(div);
                    });
                }
            } catch(e) { dom.loader.classList.add('hidden'); }
        }

        function selectDestination(place) {
            const latLng = L.latLng(place.lat, place.lon);
            dom.searchResults.classList.add('hidden');
            dom.searchInput.value = place.display_name.split(',')[0];
            dom.destName.textContent = place.display_name.split(',')[0];
            
            if (state.destMarker) state.map.removeLayer(state.destMarker);
            state.destMarker = L.marker(latLng, { icon: L.divIcon({html: '<i class="ph-fill ph-map-pin text-4xl text-red-500 drop-shadow-lg" style="margin-top:-36px; margin-left:-18px;"></i>'}) }).addTo(state.map);
            
            if (state.currentLocation) calculateRoute(state.currentLocation, latLng);
        }

        async function calculateRoute(start, end) {
            // OSRM Profile Selection for Accurate Calculations
            const profileMap = { 'driving': 'car', 'walking': 'foot', 'cycling': 'bike' };
            const profile = profileMap[state.travelMode];
            
            const url = `https://router.project-osrm.org/route/v1/${profile}/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson&steps=true`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                if(data.routes && data.routes.length > 0) {
                    state.routeData = data.routes[0];
                    if (state.routeLayer) state.map.removeLayer(state.routeLayer);
                    
                    const latLngs = state.routeData.geometry.coordinates.map(c => [c[1], c[0]]);
                    state.routeLayer = L.polyline(latLngs, { color: '#3B82F6', weight: 6, opacity: 0.8 }).addTo(state.map);
                    state.map.fitBounds(state.routeLayer.getBounds(), { padding: [50, 200] });

                    // Time Formatting
                    const mins = Math.round(state.routeData.duration / 60);
                    let timeStr = mins > 60 ? `${Math.floor(mins/60)} hr ${mins%60} min` : `${mins} min`;

                    dom.previewDuration.textContent = timeStr;
                    dom.previewDistance.textContent = (state.routeData.distance / 1000).toFixed(1) + " km";
                    dom.routePreview.classList.remove('hidden');
                    dom.modeSelector.classList.add('hidden');
                }
            } catch (e) { console.error(e); }
        }

        function startNavigation() {
            if(!state.routeData) return;
            state.isNavigating = true;
            dom.routePreview.classList.add('hidden');
            dom.searchBox.classList.add('opacity-0', 'pointer-events-none');
            dom.navStatus.classList.remove('hidden');
            dom.navInstruction.classList.remove('hidden');
            state.map.setZoom(19);
            updateNavLogic(state.currentLocation);
        }

        function endNavigation() {
            state.isNavigating = false;
            dom.navStatus.classList.add('hidden');
            dom.navInstruction.classList.add('hidden');
            dom.searchBox.classList.remove('opacity-0', 'pointer-events-none');
            dom.routePreview.classList.remove('hidden');
            state.map.setZoom(15);
        }

        function clearRoute() {
            if (state.routeLayer) state.map.removeLayer(state.routeLayer);
            if (state.destMarker) state.map.removeLayer(state.destMarker);
            dom.routePreview.classList.add('hidden');
            dom.modeSelector.classList.remove('hidden');
            dom.searchInput.value = '';
        }

        function updateNavLogic(userLoc) {
            if(!state.routeLayer || !state.routeData) return;

            // 1. Get distance remaining
            const distToDest = userLoc.distanceTo(state.destMarker.getLatLng());
            
            // 2. Calculate percentage complete (Simple linear approximation for this demo)
            const totalDist = state.routeData.distance;
            const fraction = 1 - (distToDest / totalDist);
            const percent = Math.min(100, Math.max(0, fraction * 100));
            dom.tripProgress.style.width = `${percent}%`;

            // 3. Calculate Time Remaining based on Mode
            // We use the original API duration and scale it by remaining distance
            // This ensures "Walking" times stay slow and "Driving" times stay fast
            const remainingSeconds = state.routeData.duration * (1 - fraction);

            // Update UI
            const now = new Date();
            const arrival = new Date(now.getTime() + remainingSeconds * 1000);
            dom.navEta.textContent = arrival.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            dom.navMin.textContent = Math.ceil(remainingSeconds / 60);
            dom.navKm.textContent = (distToDest / 1000).toFixed(1);

            // Mock Instructions
            if (distToDest < 20) {
                dom.maneuverText.textContent = "Arrived!";
                if(!state.isMuted) speak("You have arrived.");
            } else {
                dom.maneuverText.textContent = "Follow route";
                dom.maneuverDist.textContent = distToDest > 1000 ? (distToDest/1000).toFixed(1) + " km" : Math.round(distToDest) + " m";
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(u);
        }

        init();
    </script>
</body>
</html>
